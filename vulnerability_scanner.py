#!/usr/bin/env python3

import nmap
from termcolor import colored

def scan_vulnerabilities(target):
    # Create a port scanner object
    scanner = nmap.PortScanner()

    # Scan the target system for vulnerabilities
    scanner.scan(target, arguments="-Pn -p 21,22,23,25,53,80,111,139,445,512,513,514,1099,1524,2049,2121,3306,3632,5432,5900,6000,6667,6697,8009,8180,8787,35765,42768,45341,46329 -sV --script vulners")

    # Get scan results and extract vulnerabilities
    vulnerabilities = []
    for host in scanner.all_hosts():
        for port in scanner[host].all_protocols():
            input_data = scanner[host][port] 
            for port, details in input_data.items():
                if details["state"] == "open":
                    service = details["name"]
                    list_name = "vulnerabilities" + "_" + service
                    list_name = list()
                    if "script" in details:
                        #print("present.............")
                        if "vulners" in details["script"]:
                            cve_list = details["script"]["vulners"].strip()
                            for cve in cve_list.split('\n'):
                                if cve.strip().startswith("CVE"):
                                    list_name.append((host, port, service, cve.strip()))
                            vulnerabilities.append(list_name)

    # Return the list of vulnerabilities found
    return vulnerabilities

if __name__ == "__main__":
    
    target = "10.0.2.100" # *** Enter the Target Address Here ***
    
    vulnerabilities = scan_vulnerabilities(target)
    print()
    if vulnerabilities:
        print("[+] Vulnerabilities found:")
        print("Exploit List......")
        for vuln in vulnerabilities:       
            if len(vuln) > 0:
                print("    Host    :", vuln[0][0])
                print("    Port    :", vuln[0][1])
                print("    Service :", vuln[0][2])
                ser_name = vuln[0][2]
                name_of_list = ser_name + "_list"
                name_of_list = list()
                name_of_list = vuln
                print("    CVEs    :")
                for cves in name_of_list:
                    cve_parts = cves[3].split("\t")
                    cve_score = float(cve_parts[1])
                    if cve_score > 7.0:
                        print("             ",colored(cves[3], "red", attrs=["bold"]))
                    elif cve_score < 3.0:
                        print("             ",colored(cves[3], "green", attrs=["bold"]))
                    else:
                        print("             ",colored(cves[3], "yellow"))
                
                print()
                print("-" * 110)
                print()

    else:
        print("No vulnerabilities found.")
